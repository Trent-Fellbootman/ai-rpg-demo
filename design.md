# 设计文档

AI RPG Demo是一款漫画交互的AI RPG游戏（漫画有点难做，现在就是图片加文字，图片为主），
受了AI Dungeon的启发，想法是：

- AI Dungeon用AI实现无限流RPG的思路是对的，但操作方式太反人类，
又要输文字，又要读文字，对普通用户太不友好
- 我们把输文字改成让AI揣摩用户心理，给出选择，用户在大部分情况下点一点就行，不用打字；
把读文字改成看图片，并且一幕一幕地，不至于看到一大段字被劝退。

## Demo结构

主要有这些功能：

- 游戏流程，就是从一个世界状态开始，用户不断做动作，AI不断推动世界状态变化，这个游玩逻辑
- UGC社区：用户可以创建自己的游戏设定，公有的游戏模板可以被分享到平台，其他用户可以玩这个游戏，
点赞，评论等等
- 推荐系统：根据点赞量、游玩量在主页推送优秀的游戏模板
- 简单的编辑器：提供了一个编辑器页面供用户创建游戏模板
- 用户管理与鉴权：每个用户只能看到自己的（以及公有的）游戏模板和游戏流程
- 故事幻灯片模式：可以将游戏流程里面的每一幕提取出来，做成放映模式的幻灯片

## 实现逻辑

### 游戏流程

游戏世界的发展被建模为马尔可夫过程，
每一步对应一个世界状态，从一个世界状态到下一个世界状态的转移由AI决定，
而用户所看到的当前世界描述（对应observation）、图片都由当前世界状态决定。

每次用户选择或输入动作，大模型根据当前状态生成这些东西：

- 下一个世界状态，包含了用户能看到和看不到的东西；
- 呈现给用户的世界状态文字描述，比较短；
- 发给图片生成模型的prompt，图片用Flux Schnell生成，呈现给用户；
- 下一个世界状态下，几个可能的动作，供用户选择。

### 优化

延迟上做了些优化，主要是：

- 内容生成并发化：每一步先生成下一个世界状态，根据世界状态再并行生成其他信息。
- 流式生成：对于世界状态和可能的动作，输出第一个token时用户侧就可以看到，
不用等待生成完成。

## 技术栈

使用serverless架构，全栈使用Next.js+HeroUI（NextUI），
后端部分数据库用的Supabase提供的postgresql接口，然后用prisma包了一层，
图片的存储也是用的Supabase storage。
